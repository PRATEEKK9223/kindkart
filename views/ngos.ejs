<% layout('layouts/main') -%>

<h2>NGO Directory</h2>

<div class="row">
  <div class="col-md-4">
    <form class="mb-3" method="get">
      <input type="text" name="city" class="form-control mb-2" placeholder="City" value="<%= city || '' %>">
      <input type="text" name="category" class="form-control mb-2" placeholder="Accepts (e.g. Food)" value="<%= category || '' %>">
      <button class="btn btn-outline-primary">Filter</button>
    </form>
  </div>
  <div class="col-md-8">
    <% ngos.forEach(ngo => { %>
      <div class="card mb-2">
        <div class="card-body d-flex">
          <div class="flex-grow-1">
            <h5><%= ngo.name %> <% if (ngo.verified) { %><span class="badge bg-success">Verified</span><% } %></h5>
            <p class="mb-1"><%= ngo.description %></p>
            <small class="text-muted"><%= ngo.city %> â€¢ Accepts: <%= ngo.accepts.join(', ') %></small>
          </div>
          <div class="text-end">
            <a href="/ngos/<%= ngo._id %>" class="btn btn-sm btn-primary">View</a>
            <button class="btn btn-sm btn-outline-secondary donate-here" data-ngo='<%- JSON.stringify({ _id: ngo._id, name: ngo.name }) %>'>Donate Here</button>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<script>
  // donate-here will copy NGO ID to cart form's ngoId input (simplified flow)
  document.addEventListener('click', e => {
    if (e.target && e.target.matches('.donate-here')) {
      const ngo = JSON.parse(e.target.getAttribute('data-ngo'));
      const ngoIdInput = document.getElementById('ngoId');
      if (ngoIdInput) {
        ngoIdInput.value = ngo._id;
        alert('NGO selected: ' + ngo.name + '. Now go to Cart and submit donation.');
        window.location.href = '/cart';
      }
    }
  });
</script>
